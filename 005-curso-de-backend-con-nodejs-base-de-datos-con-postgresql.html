<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Curso de Backend con Node.js: Base de Datos con PostgreSQL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
</head>

<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col">
                <h1>Curso de Backend con Node.js: Base de Datos con PostgreSQL</h1>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <ul class="list-group">
                    <a href="./index.html" class="list-group-item">Volver</a>
                </ul>
            </div>
        </div>

        <section class="container">
            <h3>Secci√≥n 1 de 27 - Persistencia de datos en Node.js</h3>

        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 2 de 27 - Platzi Store: instalaci√≥n y presentaci√≥n del proyecto</h3>
            <p>
                <a
                    href="https://github.com/platzi/curso-nodejs-postgres">https://github.com/platzi/curso-nodejs-postgres</a>
            </p>
            <pre class="prettyprint">

                > npm i
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 3 de 27 - Instalaci√≥n Docker</h3>
            <div class="MaterialLecture-text">
                <p>Durante el resto del curso vamos a usar Docker para configurar nuestra base de datos y conectarla con
                    el servidor de Node.js. Para tomar este curso no es necesario saber Docker a profundidad, en cada
                    clase te explicaremos el paso a paso y los comandos que requerimos para usar Docker. Recuerda que
                    puedes tomar el <a href="https://platzi.com/cursos/docker/" target="_blank" rel=" noopener">Curso de
                        Docker</a> para profundizar m√°s en esta herramienta.</p>
                <p>Seg√∫n el sistema operativo que utilices puede variar la instalaci√≥n, as√≠ que a continuaci√≥n te dar√©
                    las indicaciones base para la instalaci√≥n seg√∫n tu sistema operativo:</p>
                <h2>Instalaci√≥n en Windows con WSL (Recomendada) üêß</h2>
                <p>Debes descargar el instalador desde la p√°gina de <a
                        href="https://docs.docker.com/desktop/install/windows-install/" target="_blank"
                        rel=" noopener">Docker for Windows.</a></p>
                <p>Cuando ya tienes instalado <strong>Docker Desktop</strong> dentro de tus programas debes abrirlo y
                    debes asegurarte que la opci√≥n <strong>‚ÄúUse the WSL 2 based engine‚Äù</strong> est√° habilitada:</p>
                <figure><img src="https://i.imgur.com/COPXJpw.png" alt="WSL"></figure>
                <p>Luego en la secci√≥n ‚ÄúResources &gt; WSL Integration‚Äù, asegurarate que la opcion ‚ÄúEnable integration
                    with my default WSL distro‚Äù, este habilitada:</p>
                <figure><img src="https://i.imgur.com/g20OhlL.png" alt="Resources"></figure>
                <p>Puedes ver m√°s detalles de Docker con WLS üëâ <a href="https://docs.docker.com/desktop/windows/wsl/"
                        target="_blank" rel=" noopener">Docker Desktop WSL 2 backend</a></p>
                <h2>Instalaci√≥n en Windows ü™ü</h2>
                <p>Debes descargar el instalador desde la p√°gina de <a
                        href="https://docs.docker.com/desktop/install/windows-install/" target="_blank"
                        rel=" noopener">Docker for Windows.</a></p>
                <p>Cuando ya tienes instalado <strong>Docker Desktop</strong> dentro de tus programas, una de las cosas
                    que debes tener en cuenta en la instalaci√≥n con Windows es que debes contar con <strong>Windows 10
                        de 64 Bits</strong> o superior y debes habilitar el <strong><a
                            href="https://docs.docker.com/desktop/install/windows-install/#system-requirements"
                            target="_blank" rel=" noopener">Hyper-V</a></strong> de Windows.</p>
                <p>Si quieres conocer los detalles, aqu√≠ te dejo el detalle como <a
                        href="https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v"
                        target="_blank" rel=" noopener">habilitar <strong>Hyper-V</strong> desde la Interfaz de
                        Windows</a></p>
                <figure><img src="https://i.imgur.com/bDSp6d0.png" alt="Hyper-V"></figure>
                <h2>Instalaci√≥n en macOS üçé</h2>
                <p>En Mac tienes dos opciones. Todo depender√° si tienes los nuevos chips M1 o Intel, ya que hay un
                    instalable apropiado para ambas arquitecturas de chip. Puedes escoger el instalable desde <a
                        href="https://docs.docker.com/desktop/install/mac-install/" target="_blank"
                        rel=" noopener">Install Docker Desktop on Mac</a>.</p>
                <p>Adicionalmente, si cuentas con los nuevos chips M1, debes ejecutar la siguiente instrucci√≥n en tu
                    terminal <code>softwareupdate --install-rosetta</code></p>
                <p>Una vez descargues el instalador adecuado, solo debes seguir los pasos y pasar <strong>Docker
                        Desktop</strong> a tus aplicaciones.</p>
                <figure><img src="https://i.imgur.com/qH2p2EI.png" alt="drag"></figure>
                <h2>Instalaci√≥n en Ubuntu üêß</h2>
                <p>Estos son los pasos para instalarlo dentro de Ubuntu, sin embargo, tambi√©n puedes ver
                    directamente&nbsp;<a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank"
                        rel=" noopener">Install Docker Engine on Ubuntu</a></p>
                <pre><code class="language-bash">sudo apt-get update
                </code></pre>
                <pre><code class="language-bash">sudo apt-get install \
                    ca-certificates \
                    curl \
                    gnupg \
                    lsb-release
                </code></pre>
                <pre><code class="language-bash">sudo mkdir -p /etc/apt/keyrings
                </code></pre>
                <pre><code class="language-bash">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                </code></pre>
                <pre><code class="language-bash"><span class="hljs-built_in">echo</span> \
                  <span class="hljs-string">"deb [arch=<span class="hljs-variable">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                  <span class="hljs-variable">$(lsb_release -cs)</span> stable"</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
                </code></pre>
                <pre><code class="language-bash">sudo apt-get update
                </code></pre>
                <pre><code class="language-bash">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
                </code></pre>
                <pre><code class="language-bash">sudo docker run hello-world
                </code></pre>
                <p>Para otras distribuciones de Linux:</p>
                <ul>
                    <li><a href="https://docs.docker.com/engine/install/centos/" target="_blank" rel=" noopener">Install
                            Docker Engine on CentOS</a></li>
                    <li><a href="https://docs.docker.com/engine/install/debian/" target="_blank" rel=" noopener">Install
                            Docker Engine on Debian</a></li>
                    <li><a href="https://docs.docker.com/engine/install/fedora/" target="_blank" rel=" noopener">Install
                            Docker Engine on Fedora</a></li>
                </ul>
            </div>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 4 de 27 - Configuraci√≥n de Postgres en Docker</h3>
            <pre class="prettyprint">

                > mkdir postgres_data
            </pre>
            <p>Agregar esa carpeta al gitignore</p>
            <pre class="prettyprint">

                version: '3.3'

                services:
                  postgres:
                    image: postgres:13
                    environment:
                      - POSTGRES_DB=my_store
                      - POSTGRES_USER=nico
                      - POSTGRES_PASSWORD=admin123
                    ports:
                      - 5432:5432
                
            </pre>

            <pre class="prettyprint">

                > docker-compose up -d postgres
                > sudo docker-compose up -d postgres
                > sudo docker-compose ps
                > sudo docker-compose down
                > sudo docker-compose ps
                > sudo docker-compose up -d postgres
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 5 de 27 - Explorando Postgres: interfaces gr√°ficas vs. terminal</h3>
            <pre class="prettyprint">

                > sudo docker-compose exec postgres bash
                > psql -h localhost -d my_store -U nico
                > \d+
                > \q
                > exit
            </pre>

            <pre class="prettyprint">

                pgadmin:
                image: dpage/pgadmin4
                environment:
                  - PGADMIN_DEFAULT_EMAIL=admin@mail.com
                  - PGADMIN_DEFAULT_PASSWORD=root
                ports:
                  - 5050:80
            </pre>

            <pre class="prettyprint">

                > sudo docker-compose up -d pgadmin
                > sudo docker-compose ps
            </pre>
            <p>
                <a href="http://localhost:5050/">http://localhost:5050/</a>
                <br>
                Crear un nuevo servidor
            </p>

            <pre class="prettyprint">

                > sudo docker ps
                > sudo docker inspect ID_CONTENEDOR ANTERIOR

                "IPAddress": "172.19.0.2"
            </pre>

            <p>Este paso estuve perdido un poco... no necesite el IP</p>

            <pre class="prettyprint">

                CREATE TABLE tasks (
                    id serial PRIMARY KEY,
                    title VARCHAR ( 255 ) NOT NULL,
                    completed boolean DEFAULT false
                )
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 6 de 27 - Integraci√≥n de node-postgres</h3>
            <pre class="prettyprint">

                > npm i pg
            </pre>
            <p>
                M√°s info en: <a href="https://node-postgres.com/">https://node-postgres.com/</a>
            </p>
            <pre>
                > mkdir libs
            </pre>
            <pre class="prettyprint">
            
                const { Client } = require('pg')

                async function getConnection() {
                  const client = new Client({
                    host: 'localhost',
                    port: 5433,
                    user: 'nico',
                    password: 'admin123',
                    database: 'my_store'
                  })
                  await client.connect()
                  return client
                }
                
                module.exports = getConnection
                
            </pre>

            <pre class="prettyprint">
            
                async find() {
                    const client = await getConnection()
                    const rta = await client.query('SELECT * FROM tasks')
                    return rta.rows;
                }
            </pre>
            <p>
                <a href="http://localhost:3000/api/v1/users">http://localhost:3000/api/v1/users</a>
            </p>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 7 de 23 - Manejando un Pool de conexiones</h3>

            <p>La anterior conexi√≥n que hicimos se puede considerar mala practica, debido
                a que estamos generando una conexi√≥n nueva a la base de datos en cada petici√≥n
                a la api.
                <br>
                Lo ideal es mantener siempre la misma conexi√≥n.
                <br>
                <a href="https://node-postgres.com/features/pooling">https://node-postgres.com/features/pooling</a>
            </p>

            <pre class="prettyprint">
            
                const { Pool } = require('pg')

                const pool = new Pool({
                  host: 'localhost',
                  port: 5433,
                  user: 'nico',
                  password: 'admin123',
                  database: 'my_store'
                })
                
                module.exports = pool
                
            </pre>

            <pre class="prettyprint">
            
                constructor(){
                    this.pool = pool
                    this.pool.on('error', (err) => console.error(err))
                  }
                
                  async find() {
                    const query = 'SELECT * FROM tasks'
                    const rta = this.pool.query(query)
                    return (await rta).rows;
                  }
                }
            </pre>

            <p>
                <a href="http://localhost:3000/api/v1/products">http://localhost:3000/api/v1/products</a>
            </p>
            
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 8 de 27 - Variables de ambiente en Node.js</h3>

            <pre class="prettyprint">
            
                > mkdir config
                > touch config/config.js
                > npm i dotenv
            </pre>

            <pre class="prettyprint">

                require('dotenv').config()
            
                const config = {
                    env: process.env.NODE_ENV || 'dev',
                    port: process.env.PORT || 3000,
                    dbUser: process.env.DB_USER,
                    dbPassword: process.env.DB_PASSWORD,
                    dbHost: process.env.DB_HOST,
                    dbName: process.env.DB_NAME,
                    dbPort: process.env.DB_PORT,
                  }
                  
                  module.exports = { config }
                  
            </pre>
            
            <pre class="prettyprint">
            
                const { Pool } = require('pg')

                const { config } = require('./../config/config')
                
                const USER = encodeURIComponent(config.dbUser)
                const PASSWORD = encodeURIComponent(config.dbPassword)
                
                const URI = `postgres://${ USER }:${ PASSWORD }@${ config.dbHost }:${ config.dbPort }/${ config.dbName }`
                
                const pool = new Pool({
                  connectionString: URI
                })
                
                module.exports = pool
                
            </pre>
            
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 9 de 27 - ¬øQu√© es un ORM? Instalaci√≥n y configuraci√≥n de Sequelize ORM</h3>
            <pre class="prettyprint">
            
                > npm i sequelize
                > npm i pg-hstore
            </pre>

            <pre class="prettyprint">
            
                const { Sequelize } = require('sequelize')

                const { config } = require('./../config/config')
                
                const USER = encodeURIComponent(config.dbUser)
                const PASSWORD = encodeURIComponent(config.dbPassword)
                
                const URI = `postgres://${ USER }:${ PASSWORD }@${ config.dbHost }:${ config.dbPort }/${ config.dbName }`
                
                const sequelize = new Sequelize(URI, {
                  dialect: 'postgres',
                  logging: true
                })
                
                module.exports = sequelize
                
            </pre>

            <pre class="prettyprint">
            
                const sequelize = require('./../libs/sequelize')

                class ProductsService {
                
                  constructor(){
                    this.products = [];
                    this.generate();
                  }
                
                  async find() {
                    const query = 'SELECT * FROM tasks'
                    const [ data ] = await sequelize.query(query)
                    return data;
                  }
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 10 de 27 - Tu primer modelo en sequelize</h3>
            <pre class="prettyprint">
            
                > mkdir db
                > mkdir db/models
                > touch db/models/user.model.js
                > touch db/models/index.js
            </pre>

            <pre class="prettyprint">
            
                // user.model.js

                const { Model, DataTypes, Sequelize } = require('sequelize')

                const USER_TABLE = 'users'
                
                const UserSchema = {
                  id: {
                    allowNull: false,
                    autoIncrement: true,
                    primaryKey: true,
                    type: DataTypes.INTEGER
                  },
                  email: {
                    allowNull: false,
                    type: DataTypes.STRING,
                    unique: true,
                  },
                  password: {
                    allowNull: false,
                    type: DataTypes.STRING
                  },
                  createdAt: {
                    allowNull: false,
                    type: DataTypes.DATE,
                    field: 'create_at',
                    defaultValue: Sequelize.NOW
                  }
                }
                
                class User extends Model {
                  static associate() {
                
                  }
                
                  static config(sequelize) {
                    return {
                      sequelize,
                      tableName: USER_TABLE,
                      modelName: 'User',
                      timestamps: false
                    }
                  }
                }
                
                module.exports = { USER_TABLE, UserSchema, User }
                
            </pre>

            <pre class="prettyprint">
            
                // models/index.js

                const { User, UserSchema } = require('./user.model')

                function setupModels(sequelize) {
                  User.init(UserSchema, User.config(sequelize))
                }
                
                module.exports = setupModels
                
            </pre>

            <pre class="prettyprint">
            
                // libs/sequelize.js

                const { Sequelize } = require('sequelize')

                const { config } = require('./../config/config')
                const setupModels = require('./../db/models')
                
                const USER = encodeURIComponent(config.dbUser)
                const PASSWORD = encodeURIComponent(config.dbPassword)
                
                const URI = `postgres://${ USER }:${ PASSWORD }@${ config.dbHost }:${ config.dbPort }/${ config.dbName }`
                
                const sequelize = new Sequelize(URI, {
                  dialect: 'postgres',
                  logging: true
                })
                
                setupModels(sequelize)
                
                sequelize.sync()
                
                module.exports = sequelize
                
            </pre>

            <pre class="prettyprint">
            
                // user.service.js

                const boom = require('@hapi/boom');

                const { models } = require('./../libs/sequelize')
                
                class UserService {
                  constructor() {}
                
                  async find() {
                    const rta = await models.User.findAll()
                    return rta;
                  }
                
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 11 de 27 - Crear, Actualizar y Eliminar</h3>
            <pre class="prettyprint">
            
                const Joi = require('joi');

                const id = Joi.number().integer();
                const email = Joi.string().email();
                const password = Joi.string().min(8);
                const role = Joi.string().min(5)
                
                const createUserSchema = Joi.object({
                  email: email.required(),
                  password: password.required(),
                  // role: role.required()
                });
                
                const updateUserSchema = Joi.object({
                  email: email,
                  role: role,
                });
                
                const getUserSchema = Joi.object({
                  id: id.required(),
                });
                
                module.exports = { createUserSchema, updateUserSchema, getUserSchema }
                
            </pre>

            <pre class="prettyprint">
            
                const express = require('express');

                const UserService = require('./../services/user.service');
                const validatorHandler = require('./../middlewares/validator.handler');
                const { updateUserSchema, createUserSchema, getUserSchema } = require('./../schemas/user.schema');
                
                const router = express.Router();
                const service = new UserService();
                
                router.get('/', async (req, res, next) => {
                  try {
                    const users = await service.find();
                    res.json(users);
                  } catch (error) {
                    next(error);
                  }
                });
                
                router.get('/:id',
                  validatorHandler(getUserSchema, 'params'),
                  async (req, res, next) => {
                    try {
                      const { id } = req.params;
                      const user = await service.findOne(id);
                      res.json(user);
                    } catch (error) {
                      next(error);
                    }
                  }
                );
                
                router.post('/',
                  validatorHandler(createUserSchema, 'body'),
                  async (req, res, next) => {
                    try {
                      const body = req.body;
                      const newUser = await service.create(body);
                      res.status(201).json(newUser);
                    } catch (error) {
                      next(error);
                    }
                  }
                );
                
                router.patch('/:id',
                  validatorHandler(getUserSchema, 'params'),
                  validatorHandler(updateUserSchema, 'body'),
                  async (req, res, next) => {
                    try {
                      const { id } = req.params;
                      const body = req.body;
                      const user = await service.update(id, body);
                      res.json(user);
                    } catch (error) {
                      next(error);
                    }
                  }
                );
                
                router.delete('/:id',
                  validatorHandler(getUserSchema, 'params'),
                  async (req, res, next) => {
                    try {
                      const { id } = req.params;
                      await service.delete(id);
                      res.status(201).json({id});
                    } catch (error) {
                      next(error);
                    }
                  }
                );
                
                module.exports = router;
                                
            </pre>

            <pre class="prettyprint">
            
                const boom = require('@hapi/boom');

                const { models } = require('./../libs/sequelize')
                
                class UserService {
                  constructor() {}
                
                  async create(data) {
                    const newUser = await models.User.create(data)
                    return newUser;
                  }
                
                  async find() {
                    const rta = await models.User.findAll()
                    return rta;
                  }
                
                  async findOne(id) {
                    const user = await models.User.findByPk(id)
                    if (!user) {
                      throw boom.notFound('user not found')
                    }
                    return user;
                  }
                
                  async update(id, changes) {
                    const user = await this.findOne(id)
                    const rta = await user.update(changes)
                    return rta;
                  }
                
                  async delete(id) {
                    const user = await this.findOne(id)
                    await user.destroy()
                    return { id };
                  }
                }
                
                module.exports = UserService;
                
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 12 de 27 - Cambiando la base de datos a MySQL</h3>
            <p>Peque√±o parentesis, mejorar la presentaci√≥n de errores de orm</p>
            <pre class="prettyprint">
            
              function ormErrorHandler(err, req, res, next) {
                if (err instanceof ValidationError) {
                  res.status(409).json({
                    statusCode: 409,
                    message: err.name,
                    errors: err.errors
                  })
                }
                next(err)
              }
            </pre>

            <pre class="prettyprint">
            
              app.use(logErrors);
              app.use(ormErrorHandler);
              app.use(boomErrorHandler);
              app.use(errorHandler);
            </pre>

            <pre class="prettyprint">
            
            mysql:
              image: mysql:5
              environment:
                - MYSQL_DATABASE=my_store
                - MYSQL_USER=nico
                - MYSQL_ROOT_PASSWORD=admin123
                - MYSQL_PORT=3306
              ports:
                - 3306:3306
              volumes:
                - ./mysql_data:/var/lib/mysql
          
            phpmyadmin:
              image: phpmyadmin/phpmyadmin
              environment:
                - MYSQL_ROOT_PASSWORD=admin123
                - PMA_HOST=mysql
              ports:
                - 8080:80
            </pre>

            <pre class="prettyprint">
            
              > sudo docker-compose up -d mysql
              > sudo docker-compose up -d phpmyadmin
            </pre>

            <p>Crear la carpeta mysql_data</p>

            <pre class="prettyprint">
            
                > npm i mysql2
            </pre>

            <p>
              Como la condiguraci√≥n es casi igual, solo vamos a cambiar el puerto de la base de datos en las variables de entorno.
              <br>
              y tambien la configuracion de sequelize, cambiar postgres por mysql
            </p>

            <p>
              Hubo un problema, entonces se cambia una variable de configuracion en docker y en .env
            </p>

            <pre class="prettyprint">
            
              - MYSQL_USER=root
            </pre>

            <p>y en .env ya no es nico sino root</p>

            <a href="http://localhost:8080/">http://localhost:8080/</a>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 13 de 27 - ¬øQu√© son las migraciones? Migraciones en Sequelize ORM</h3>
            <pre class="prettyprint">
            
                > npm i sequelize-cli -D
                > touch .sequelizerc
                > mkdir db/migrations
                > mkdir db/seeders
                > touch db/config.js
            </pre>

            <pre class="prettyprint">
            
              module.exports = {
                'config': './db/config.js',
                'models-path': './db/models/',
                'migrations-path': './db/migrations/',
                'seeders-path': './db/seeders/',
              }
            </pre>

            <pre class="prettyprint">
            
              const { config } = require('./../config/config')

              const USER = encodeURIComponent(config.dbUser)
              const PASSWORD = encodeURIComponent(config.dbPassword)
              
              const URI = `mysql://${ USER }:${ PASSWORD }@${ config.dbHost }:${ config.dbPort }/${ config.dbName }`
              
              module.exports = {
                development: {
                  url: URI,
                  dialect: 'postgres'
                },
                production: {
                  url: URI,
                  dialect: 'postgres'
                },
              }
              
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 14 de 27 - Configurando y corriendo migraciones con npm scripts</h3>
            <pre class="prettyprint">
            
              "scripts": {
                "dev": "nodemon index.js",
                "start": "node index.js",
                "lint": "eslint",
                "migrations:generate": "sequelize-cli migration:generate --name"
              },
            </pre>

            <pre class="prettyprint">
              
              > npm run migrations:generate create-user
            </pre>

            <p>En el archivo sequelize se quita la sincronizaci√≥n</p>

            <pre class="prettyprint">
            
              // sequelize.sync()
            </pre>

            <p>En el archivo de la migracion</p>

            <pre class="prettyprint">
            
              'use strict';

              const { UserSchema, USER_TABLE } = require('./../models/user.model')
              
              /** @type {import('sequelize-cli').Migration} */
              module.exports = {
                async up (queryInterface, Sequelize) {
                  /**
                   * Add altering commands here.
                   *
                   * Example:
                   * await queryInterface.createTable('users', { id: Sequelize.INTEGER });
                   */
                  await queryInterface.createTable(USER_TABLE, UserSchema);
                },
              
                async down (queryInterface, Sequelize) {
                  /**
                   * Add reverting commands here.
                   *
                   * Example:
                   * await queryInterface.dropTable('users');
                  */
                  await queryInterface.dropTable(USER_TABLE);
                }
              };
              
            </pre>

            <p>package.json</p>

            <pre class="prettyprint">
            
              "migrations:run": "sequelize-cli db:migrate",
              "migrations:revert": "sequelize-cli db:migrate:undo",
              "migrations:delete": "sequelize-cli db:migrate:undo:all"
            </pre>

            <p>Para seguir con el video hay que volver a cambiar a postgres</p>
            <ul>
              <li>el archivo de sequelize</li>
              <li>en variables de entorno - el puerto y el usuario (tambien development en NODE_ENV)</li>
            </ul>

            <pre class="prettyprint">
            
                > npm run migrations:run
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 15 de 27 - Modificando una entidad</h3>
            <pre class="prettyprint">
            
              password: {
                allowNull: false,
                type: DataTypes.STRING
              },
              role: {
                allowNull: false,
                type: DataTypes.STRING,
                defaultValue: 'customer'
              },
              createdAt: {
                allowNull: false,
                type: DataTypes.DATE,
                field: 'create_at',
                defaultValue: Sequelize.NOW
              }
            </pre>
            <pre class="prettyprint">
            
                > npm run migrations:generate add-role
            </pre>

            <pre class="prettyprint">
            
              'use strict';

              const { UserSchema, USER_TABLE } = require('./../models/user.model')
              
              /** @type {import('sequelize-cli').Migration} */
              module.exports = {
                async up (queryInterface, Sequelize) {
                  /**
                   * Add altering commands here.
                   *
                   * Example:
                   * await queryInterface.createTable('users', { id: Sequelize.INTEGER });
                   */
                  await queryInterface.addColumn(USER_TABLE, 'role', UserSchema.role);
                },
              
                async down (queryInterface, Sequelize) {
                  /**
                   * Add reverting commands here.
                  *
                  * Example:
                  * await queryInterface.dropTable('users');
                  */
                  await queryInterface.removeColumn(USER_TABLE, 'role', UserSchema.role);
                }
              };
              
            </pre>

            <pre class="prettyprint">
            
              const createUserSchema = Joi.object({
                email: email.required(),
                password: password.required(),
                role: role.required()
              });
            </pre>

            <pre class="prettyprint">
            
                > npm run migrations:run
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 16 de 27 - Relaciones uno a uno</h3>
            <pre class="prettyprint">
            
              const { Model, DataTypes, Sequelize } = require('sequelize')

              const CUSTOMER_TABLE = 'customers'
              
              const CustomerSchema = {
                id: {
                  allowNull: false,
                  autoIncrement: true,
                  primaryKey: true,
                  type: DataTypes.INTEGER
                },
                name: {
                  allowNull: false,
                  type: DataTypes.STRING
                },
                lastName: {
                  allowNull: false,
                  type: DataTypes.STRING,
                  field: 'last_name'
                },
                phone: {
                  allowNull: false,
                  type: DataTypes.STRING
                },
                createdAt: {
                  allowNull: false,
                  type: DataTypes.DATE,
                  field: 'created_at',
                  defaultValue: Sequelize.NOW
                }
              }
              
              class Customer extends Model {
                static associate() {
              
                }
              
                static config(sequelize) {
                  return {
                    sequelize,
                    tableName: CUSTOMER_TABLE,
                    modelName: 'Customer',
                    timestamps: false
                  }
                }
              }
              
              module.exports = { CUSTOMER_TABLE, CustomerSchema, Customer }
              
            </pre>

            <pre class="prettyprint">
            
              const { User, UserSchema } = require('./user.model')
              const { Customer, CustomerSchema } = require('./customer.model')
              
              function setupModels(sequelize) {
                User.init(UserSchema, User.config(sequelize))
                User.init(CustomerSchema, Customer.config(sequelize))
              }
              
              module.exports = setupModels
              
            </pre>

            <pre class="prettyprint">
            
              const boom = require('@hapi/boom');

              const { models } = require('./../libs/sequelize')
              
              class CustomerService {
                constructor() {}
              
                async create(data) {
                  const newCustomer = await models.Customer.create(data)
                  return newCustomer;
                }
              
                async find() {
                  const rta = await models.Customer.findAll()
                  return rta;
                }
              
                async findOne(id) {
                  const customer = await models.Customer.findByPk(id)
                  if (!customer) {
                    throw boom.notFound('customer not found')
                  }
                  return customer;
                }
              
                async update(id, changes) {
                  const customer = await this.findOne(id)
                  const rta = await customer.update(changes)
                  return rta;
                }
              
                async delete(id) {
                  const customer = await this.findOne(id)
                  await customer.destroy()
                  return { id };
                }
              }
              
              module.exports = CustomerService;
              
            </pre>

            <pre class="prettyprint">
            
              const express = require('express');

              const CustomerService = require('./../services/customer.service');
              const validatorHandler = require('./../middlewares/validator.handler');
              const { updateCustomerSchema, createCustomerSchema, getCustomerSchema } = require('./../schemas/customer.schema');
              
              const router = express.Router();
              const service = new CustomerService
              
              router.get('/', async (req, res, next) => {
                try {
                  res.json(await service.find());
                } catch (error) {
                  next(error);
                }
              });
              
              router.get('/:id',
                validatorHandler(getCustomerSchema, 'params'),
                async (req, res, next) => {
                  try {
                    const { id } = req.params;
                    const customer = await service.findOne(id);
                    res.json(customer);
                  } catch (error) {
                    next(error);
                  }
                }
              );
              
              router.post('/',
                validatorHandler(createCustomerSchema, 'body'),
                async (req, res, next) => {
                  try {
                    const body = req.body;
                    const newCustomer = await service.create(body);
                    res.status(201).json(newCustomer);
                  } catch (error) {
                    next(error);
                  }
                }
              );
              
              router.patch('/:id',
                validatorHandler(getCustomerSchema, 'params'),
                validatorHandler(updateCustomerSchema, 'body'),
                async (req, res, next) => {
                  try {
                    const { id } = req.params;
                    const body = req.body;
                    const customer = await service.update(id, body);
                    res.json(customer);
                  } catch (error) {
                    next(error);
                  }
                }
              );
              
              router.delete('/:id',
                validatorHandler(getCustomerSchema, 'params'),
                async (req, res, next) => {
                  try {
                    const { id } = req.params;
                    await service.delete(id);
                    res.status(201).json({id});
                  } catch (error) {
                    next(error);
                  }
                }
              );
              
              module.exports = router;
              
              
            </pre>

            <pre class="prettyprint">
            
              const Joi = require('joi');

              const id = Joi.number().integer();
              const name = Joi.string();
              const lastName = Joi.string();
              const phone = Joi.string()
              
              const createCustomerSchema = Joi.object({
                name: name.required(),
                lastName: lastName.required(),
                phone: phone.required()
              });
              
              const updateCustomerSchema = Joi.object({
                name: name,
                lastName: lastName,
                phone: phone,
              });
              
              const getCustomerSchema = Joi.object({
                id: id.required(),
              });
              
              module.exports = { createCustomerSchema, updateCustomerSchema, getCustomerSchema }
              
            </pre>

            <pre class="prettyprint">
            
                ...
                router.use('/customers', customerRouter);
                ...

            </pre>

            <pre class="prettyprint">

              ...

              userId: {
                field: 'user_id',
                allowNull: false,
                type: DataTypes.INTEGER,
                references: {
                  model: USER_TABLE,
                  key: 'id'
                },
                onUpdate: 'CASCADE',
                onDelete: 'SET NULL'
              }

              ...
            
              class Customer extends Model {
                static associate(models) {
                  this.belongsTo(models.User, {as: 'user'})
                }

                ...
            </pre>

            <pre class="prettyprint">
            
              const { User, UserSchema } = require('./user.model')
              const { Customer, CustomerSchema } = require('./customer.model')
              
              function setupModels(sequelize) {
                User.init(UserSchema, User.config(sequelize))
                Customer.init(CustomerSchema, Customer.config(sequelize))
              
                Customer.associate(sequelize.models)
              }
              
              module.exports = setupModels    
            </pre>

            <pre class="prettyprint">
            
                > npm run migrations:generate create-customers
              </pre>
              <pre class="prettyprint">
              
                'use strict';

                const { CustomerSchema, CUSTOMER_TABLE } = require('./../models/customer.model')
                
                /** @type {import('sequelize-cli').Migration} */
                module.exports = {
                  async up (queryInterface, Sequelize) {
                    /**
                     * Add altering commands here.
                     *
                     * Example:
                     * await queryInterface.createTable('users', { id: Sequelize.INTEGER });
                     */
                    await queryInterface.createTable(CUSTOMER_TABLE, CustomerSchema);
                  },
                
                  async down (queryInterface, Sequelize) {
                    /**
                     * Add reverting commands here.
                     *
                     * Example:
                     * await queryInterface.dropTable('users');
                     */
                    await queryInterface.dropTable(CUSTOMER_TABLE);
                  }
                };
                
              </pre>
              <pre class="prettyprint">
                  
                > npm run migrations:run
              </pre>

              <pre class="prettyprint">

                ...
              
                const userId = Joi.number().integer()

                const createCustomerSchema = Joi.object({
                  name: name.required(),
                  lastName: lastName.required(),
                  phone: phone.required(),
                  userId: userId.required(),
                });
                
                const updateCustomerSchema = Joi.object({
                  name: name,
                  lastName: lastName,
                  phone: phone,
                  userId: userId,
                });

                ...
              </pre>
            </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 17 de 27 - Resolviendo las relaciones uno a uno</h3>
            <pre class="prettyprint">
            
              userId: {
                field: 'user_id',
                allowNull: false,
                type: DataTypes.INTEGER,
                unique: true,
                references: {
                  model: USER_TABLE,
                  key: 'id'
                },
                onUpdate: 'CASCADE',
                onDelete: 'SET NULL'
              }
            </pre>

            <pre class="prettyprint">
            
                > npm run migrations:generate change-user-id
            </pre>

            <pre class="prettyprint">
            
              'use strict';
              const { DataTypes } = require('sequelize')
              const { CustomerSchema, CUSTOMER_TABLE } = require('./../models/customer.model')
              
              /** @type {import('sequelize-cli').Migration} */
              module.exports = {
                async up (queryInterface, Sequelize) {
                  /**
                   * Add altering commands here.
                   *
                   * Example:
                   * await queryInterface.createTable('users', { id: Sequelize.INTEGER });
                   */
                  await queryInterface.changeColumn(CUSTOMER_TABLE, 'user_id', {
                    field: 'user_id',
                    allowNull: false,
                    type: DataTypes.INTEGER,
                    unique: true
                  });
                },
              
                async down (queryInterface, Sequelize) {
                  /**
                   * Add reverting commands here.
                   *
                   * Example:
                   * await queryInterface.dropTable('users');
                   */
                }
              };
              
            </pre>

            <pre class="prettyprint">
                
              > npm run migrations:run
            </pre>

            <pre class="prettyprint">
            
              async find() {
                const rta = await models.Customer.findAll({
                  include: ['user']
                })
                return rta;
              }
            </pre>

            <pre class="prettyprint">
            
              function setupModels(sequelize) {
                User.init(UserSchema, User.config(sequelize))
                Customer.init(CustomerSchema, Customer.config(sequelize))
              
                User.associate(sequelize.models)
                Customer.associate(sequelize.models)
              }
            </pre>

            <pre class="prettyprint">
            
              async find() {
                const rta = await models.User.findAll({
                  include: ['customer']
                })
                return rta;
              }
            </pre>

            <pre class="prettyprint">
            
              const email = Joi.string().email()
              const password = Joi.string()
              
              const createCustomerSchema = Joi.object({
                name: name.required(),
                lastName: lastName.required(),
                phone: phone.required(),
                // userId: userId.required(),
                user: Joi.object({
                  email: email.required(),
                  password: password.required()
                })
              });
            </pre>

            <pre class="prettyprint">
            
              async create(data) {
                const newUser = await models.User.create(data.user)
                console.log({ NUEVO: newUser })
                const newCustomer = await models.Customer.create({
                  ...data,
                  userId: newUser.dataValues.id
                })
                return newCustomer;
              }
            </pre>

            <p>O mejor</p>

            <pre class="prettyprint">
            
              async create(data) {

                const newCustomer = await models.Customer.create(data, {
                  include: ['user']
                })
                return newCustomer;
              }
            </pre>
        </section>
        <hr>

        <section class="container">
            <h3>Secci√≥n 17 de 27 - Relaciones uno a muchos</h3>
            
        </section>
        <hr>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
</body>

</html>